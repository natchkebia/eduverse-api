// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  ADMIN
}

enum CourseType {
  COURSE
  WORKSHOP
  MASTERCLASS
}

enum CourseStatus {
  ACTIVE
  EXPIRING
  EXPIRED
  ARCHIVED
}

/**
 * User-submitted listing lifecycle (pre-publish).
 * Separate from CourseStatus to keep existing logic intact.
 */
enum CourseRequestStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

/** ✅ შენი 14 კატეგორია */
enum CourseCategory {
  TECHNOLOGY
  DESIGN
  ART
  MARKETING
  BUSINESS_MANAGEMENT
  FINANCE
  LANGUAGES
  SCIENCE
  PSYCHOLOGY
  PERSONAL_DEVELOPMENT
  HEALTH_WELLNESS
  CRAFTS_HOBBIES
  SPORTS
  OTHER
}

/** ✅ კურსის მიწოდების ტიპი */
enum CourseDelivery {
  LIVE
  VIDEO
}

/** ✅ ფორმატი (online/onsite) */
enum CourseFormat {
  ONLINE
  ONSITE
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  password            String?
  name                String
  surname             String?
  phone               String?  @unique
  role                Role     @default(STUDENT)
  provider            String?
  avatar              String?

  // ✅ tokens — უკეთესია უნიკალური
  resetToken          String?  @unique
  resetTokenExpires   DateTime?
  verified            Boolean  @default(false)
  verificationToken   String?  @unique
  verificationExpires DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  courseRequests      CourseRequest[]
  courses             Course[] // ✅ სურვილისამებრ: approved კურსის owner/creator
}

model Course {
  id               Int            @id @default(autoincrement())
  slug             String         @unique
  type             CourseType     @default(COURSE)

  category         CourseCategory @default(OTHER)
  delivery         CourseDelivery @default(LIVE)
  format           CourseFormat   @default(ONLINE)

  creatorId        String?
  creator          User?          @relation(fields: [creatorId], references: [id], onDelete: SetNull)

  // ✅ Pricing
  originalPrice    Int
  discountedPrice  Int?
  discountPercent  Int?

  imageUrl         String

  isGeorgia        Boolean        @default(true)

  titleKa          String
  descriptionKa    String
  altTextKa        String
  buttonKa         String
  formatKa         String
  languageKa       String

  titleEn          String?
  descriptionEn    String?
  altTextEn        String?
  buttonEn         String?
  formatEn         String?
  languageEn       String?

  startDate        DateTime?
  endDate          DateTime?
  date             DateTime?

  // ✅ listing expiry date for cron/status
  listingEndsAt    DateTime?

  location         String?

  status           CourseStatus   @default(ACTIVE)

  syllabusKa       String?
  syllabusEn       String?
  mentorKa         String?
  mentorEn         String?

  videos           Video[]
  materials        Material[]

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([type, status])
  @@index([discountPercent])
  @@index([listingEndsAt])

  // ✅ useful filters
  @@index([category])
  @@index([format])
  @@index([delivery])
  @@index([isGeorgia])
}

model CourseRequest {
  id               String              @id @default(uuid())

  creatorId        String
  // ✅ audit/history რომ არ დაიკარგოს
  creator          User                @relation(fields: [creatorId], references: [id], onDelete: Restrict)

  type             CourseType          @default(COURSE)

  category         CourseCategory?
  delivery         CourseDelivery?
  format           CourseFormat?

  titleKa          String
  titleEn          String?
  descriptionKa    String
  descriptionEn    String?
  imageUrl         String?

  syllabusKa       String?
  syllabusEn       String?
  mentorKa         String?
  mentorEn         String?

  languageKa       String?
  languageEn       String?

  // ✅ Pricing
  originalPrice    Int?
  discountedPrice  Int?
  discountPercent  Int?

  // ✅ Listing payment details
  listingDays      Int?
  listingFee       Int?

  // legacy fields (optional)
  days             Int?
  price            Int?

  date             DateTime?
  location         String?
  startDate        DateTime?
  endDate          DateTime?

  requestVideos    CourseRequestVideo[]
  requestMaterials CourseRequestMaterial[]

  status           CourseRequestStatus @default(DRAFT)

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([creatorId])
  @@index([status])
  @@index([discountPercent])
}

model Video {
  id        Int     @id @default(autoincrement())
  url       String
  courseId  Int
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Material {
  id        Int     @id @default(autoincrement())
  link      String
  courseId  Int
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

/** ✅ Request-ზე ვიდეოების შენახვა */
model CourseRequestVideo {
  id              Int           @id @default(autoincrement())
  url             String
  order           Int?

  courseRequestId String
  courseRequest   CourseRequest @relation(fields: [courseRequestId], references: [id], onDelete: Cascade)

  @@index([courseRequestId])
}

/** ✅ Request-ზე მასალების შენახვა */
model CourseRequestMaterial {
  id              Int           @id @default(autoincrement())
  link            String

  courseRequestId String
  courseRequest   CourseRequest @relation(fields: [courseRequestId], references: [id], onDelete: Cascade)

  @@index([courseRequestId])
}

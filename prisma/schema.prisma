generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  ADMIN
}

enum CourseType {
  COURSE
  WORKSHOP
  MASTERCLASS
}

enum CourseStatus {
  ACTIVE
  EXPIRING
  EXPIRED
  ARCHIVED
}

/**
 * User-submitted listing lifecycle (pre-publish).
 * Separate from CourseStatus to keep existing logic intact.
 */
enum CourseRequestStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

/** ✅ შენი 14 კატეგორია */
enum CourseCategory {
  TECHNOLOGY
  DESIGN
  ART
  MARKETING
  BUSINESS_MANAGEMENT
  FINANCE
  LANGUAGES
  SCIENCE
  PSYCHOLOGY
  PERSONAL_DEVELOPMENT
  HEALTH_WELLNESS
  CRAFTS_HOBBIES
  SPORTS
  OTHER
}

/** ✅ კურსის მიწოდების ტიპი */
enum CourseDelivery {
  LIVE
  VIDEO
}

/** ✅ ფორმატი (online/onsite) */
enum CourseFormat {
  ONLINE
  ONSITE
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  password            String?
  name                String
  surname             String?
  phone               String?  @unique
  role                Role     @default(STUDENT)
  provider            String?
  avatar              String?
  resetToken          String?
  resetTokenExpires   DateTime?
  verified            Boolean  @default(false)
  verificationToken   String?
  verificationExpires DateTime?
  createdAt           DateTime @default(now())

  courseRequests      CourseRequest[]
  courses             Course[] // ✅ სურვილისამებრ: approved კურსის owner/creator

}

model Course {
  id               Int          @id @default(autoincrement())
  slug             String       @unique
  type             CourseType   @default(COURSE)

  /** ✅ ახალი */
  category         CourseCategory @default(OTHER)
  delivery         CourseDelivery @default(LIVE)
  format           CourseFormat   @default(ONLINE)

  /** ✅ სურვილისამებრ owner */
  creatorId        String?
  creator          User?          @relation(fields: [creatorId], references: [id], onDelete: SetNull)

  /** ფასი */
  originalPrice    Int
  discountedPrice  Int
  discount         String?

  imageUrl         String

  /** ძველებიც დავტოვე რომ არაფერი დაგემტვრეს (მაგრამ ლოგიკაში არ დაეყრდნო) */
  isOnline         Boolean      @default(false)
  isGeorgia        Boolean      @default(true)

  /** ✅ KA REQUIRED */
  titleKa          String
  descriptionKa    String
  altTextKa        String
  buttonKa         String
  formatKa         String
  languageKa       String

  /** ✅ EN OPTIONAL (რადგან EN ვერსიაზე არ გამოჩნდეს თუ არაა შევსებული) */
  titleEn          String?
  descriptionEn    String?
  altTextEn        String?
  buttonEn         String?
  formatEn         String?
  languageEn       String?

  /**
   * LIVE COURSE → startDate
   * WORKSHOP/MASTERCLASS → date
   * VIDEO COURSE → ორივე შეიძლება null იყოს, მაგრამ videos უნდა ჰქონდეს
   */
  startDate        DateTime?
  endDate          DateTime?
  date             DateTime?

  location         String?

  status           CourseStatus @default(ACTIVE)

  syllabusKa       String?
  syllabusEn       String?
  mentorKa         String?
  mentorEn         String?

  videos           Video[]
  materials        Material[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}


/**
 * Stores user submissions BEFORE they become real Courses.
 * Admin approval creates Course from this record.
 */
model CourseRequest {
  id               String              @id @default(uuid())

  creatorId        String
  creator          User                @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  type             CourseType          @default(COURSE)

  /** ✅ ახალი: კატეგორია/მიწოდება/ფორმატი */
  category         CourseCategory?
  delivery         CourseDelivery?
  format           CourseFormat?

  titleKa          String
  titleEn          String?
  descriptionKa    String
  descriptionEn    String?
  imageUrl         String?

  /** ✅ COURSE-სთვის */
  syllabusKa       String?
  syllabusEn       String?
  mentorKa         String?
  mentorEn         String?

  /** ✅ ენა (რადგან Course-ში გაქვს languageKa/languageEn) */
  languageKa       String?
  languageEn       String?

  /** ✅ ფასები (შენი Course-ს სტილს რომ დაემთხვეს) */
  originalPrice    Int?
  discountedPrice  Int?
  discount         String?

  /** ✅ WORKSHOP/MASTERCLASS-სთვის */
  date             DateTime?
  location         String?

  /** ✅ LIVE COURSE-სთვის */
  startDate        DateTime?
  endDate          DateTime?

  /** ✅ Listing დღეები (შენ გაქვს days/price, ვტოვებ და თან უფრო კონკრეტულად ვამატებ) */
  days             Int?
  listingDays      Int?
  listingFee       Int?

  /** ძველი price ვტოვებ backward compat-სთვის */
  price            Int?

  /** VIDEO კურსის ვიდეოები — request-ზეაც შევინახოთ რომ approve-ზე გადავიტანოთ */
  requestVideos    CourseRequestVideo[]
  requestMaterials CourseRequestMaterial[]

  status           CourseRequestStatus @default(DRAFT)

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([creatorId])
  @@index([status])
}

model Video {
  id        Int     @id @default(autoincrement())
  url       String
  courseId  Int
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Material {
  id        Int     @id @default(autoincrement())
  link      String
  courseId  Int
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

/** ✅ Request-ზე ვიდეოების შენახვა */
model CourseRequestVideo {
  id             Int          @id @default(autoincrement())
  url            String
  order          Int?

  courseRequestId String
  courseRequest   CourseRequest @relation(fields: [courseRequestId], references: [id], onDelete: Cascade)

  @@index([courseRequestId])
}

/** ✅ Request-ზე მასალების შენახვა */
model CourseRequestMaterial {
  id              Int          @id @default(autoincrement())
  link            String

  courseRequestId String
  courseRequest   CourseRequest @relation(fields: [courseRequestId], references: [id], onDelete: Cascade)

  @@index([courseRequestId])
}

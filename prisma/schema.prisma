// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  ADMIN
}

enum CourseType {
  COURSE
  WORKSHOP
  MASTERCLASS
}

enum CourseStatus {
  ACTIVE
  EXPIRING
  EXPIRED
  ARCHIVED
}

/**
 * User-submitted listing lifecycle (pre-publish).
 */
enum CourseRequestStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum CourseCategory {
  TECHNOLOGY
  DESIGN
  ART
  MARKETING
  BUSINESS_MANAGEMENT
  FINANCE
  LANGUAGES
  SCIENCE
  PSYCHOLOGY
  PERSONAL_DEVELOPMENT
  HEALTH_WELLNESS
  CRAFTS_HOBBIES
  SPORTS
  OTHER
}

enum CourseDelivery {
  LIVE
  VIDEO
}

enum CourseFormat {
  ONLINE
  ONSITE
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  password            String?
  name                String
  surname             String?
  phone               String?  @unique
  role                Role     @default(STUDENT)
  provider            String?
  avatar              String?

  resetToken          String?  @unique
  resetTokenExpires   DateTime?
  verified            Boolean  @default(false)
  verificationToken   String?  @unique
  verificationExpires DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  courseRequests      CourseRequest[]
  courses             Course[]
}

model Course {
  id               Int            @id @default(autoincrement())
  slug             String         @unique
  type             CourseType     @default(COURSE)

  category         CourseCategory @default(OTHER)
  delivery         CourseDelivery @default(LIVE)
  format           CourseFormat   @default(ONLINE)

  creatorId        String?
  creator          User?          @relation(fields: [creatorId], references: [id], onDelete: SetNull)

  originalPrice    Int
  discountedPrice  Int?
  discountPercent  Int?

  imageUrl         String

  // ✅ Workshop/LIVE extra location fields
  address          String?
  onlineUrl        String?

  isGeorgia        Boolean        @default(true)

  // ✅ i18n texts
  titleKa          String
  descriptionKa    String
  syllabusKa       String?
  mentorBioKa      String?
  mentorFirstNameKa String?
  mentorLastNameKa  String?

  titleEn          String?
  descriptionEn    String?
  syllabusEn       String?
  mentorBioEn      String?
  mentorFirstNameEn String?
  mentorLastNameEn  String?

  // Dates
  startDate        DateTime?
  endDate          DateTime?
  date             DateTime? // workshop/masterclass date

  listingEndsAt    DateTime?

  status           CourseStatus   @default(ACTIVE)

  videos           Video[]
  materials        Material[]

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([type, status])
  @@index([discountPercent])
  @@index([listingEndsAt])
  @@index([category])
  @@index([format])
  @@index([delivery])
  @@index([isGeorgia])
}

model CourseRequest {
  id               String              @id @default(uuid())

  creatorId        String
  creator          User                @relation(fields: [creatorId], references: [id], onDelete: Restrict)

  type             CourseType          @default(COURSE)

  category         CourseCategory?
  delivery         CourseDelivery?
  format           CourseFormat?

  // ✅ i18n texts (KA required; EN auto-generated on submit)
  titleKa          String
  descriptionKa    String
  syllabusKa       String?
  mentorBioKa      String?
  mentorFirstNameKa String?
  mentorLastNameKa  String?

  titleEn          String?
  descriptionEn    String?
  syllabusEn       String?
  mentorBioEn      String?
  mentorFirstNameEn String?
  mentorLastNameEn  String?

  enAutoTranslated Boolean            @default(false)

  imageUrl         String?

  // ✅ Pricing
  originalPrice    Int?
  discountedPrice  Int?
  discountPercent  Int?

  // ✅ Listing payment details
  listingDays      Int?
  listingFee       Int?

  // ✅ Event fields (workshop/masterclass)
  date             DateTime?
  // ✅ Online/Onsite specifics
  address          String?
  onlineUrl        String?

  // ✅ Live course schedule
  startDate        DateTime?
  endDate          DateTime?

  requestVideos    CourseRequestVideo[]
  requestMaterials CourseRequestMaterial[]

  status           CourseRequestStatus @default(DRAFT)

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([creatorId])
  @@index([status])
  @@index([discountPercent])
}

model Video {
  id        Int     @id @default(autoincrement())
  url       String
  courseId  Int
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Material {
  id        Int     @id @default(autoincrement())
  link      String
  courseId  Int
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model CourseRequestVideo {
  id              Int           @id @default(autoincrement())
  url             String
  order           Int?

  courseRequestId String
  courseRequest   CourseRequest @relation(fields: [courseRequestId], references: [id], onDelete: Cascade)

  @@index([courseRequestId])
}

model CourseRequestMaterial {
  id              Int           @id @default(autoincrement())
  link            String

  courseRequestId String
  courseRequest   CourseRequest @relation(fields: [courseRequestId], references: [id], onDelete: Cascade)

  @@index([courseRequestId])
}
